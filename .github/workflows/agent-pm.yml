name: Project Manager Agent

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to triage"
        required: false
        type: number

permissions:
  contents: read
  issues: write

jobs:
  triage:
    name: Triage Issue
    runs-on: ubuntu-latest
    # Only run on new issues or when status:needs-triage is added
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.action == 'opened' ||
      (github.event.action == 'labeled' &&
       github.event.label.name == 'status:needs-triage')
    steps:
      - uses: actions/checkout@v6

      - name: Determine issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue_number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if issue was created by TODO scanner
        id: skip-check
        run: |
          LABELS=$(curl -sf \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/labels" \
            | python3 -c "import sys,json; labels=[l['name'] for l in json.load(sys.stdin)]; print('true' if 'agent:todo-scanner' in labels else 'false')")
          echo "is_todo_scanner=$LABELS" >> "$GITHUB_OUTPUT"
          if [ "$LABELS" = "true" ]; then
            echo "::notice::Skipping triage — issue #${{ steps.issue.outputs.number }} was created by the TODO scanner agent"
          fi

      - name: Run PM Agent via Claude Code Action
        if: steps.skip-check.outputs.is_todo_scanner != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are the Project Manager agent for PortfolioOS.

            Triage issue #${{ steps.issue.outputs.number }}.

            Instructions:
            1. Read the issue body using the GitHub API
            2. Read docs/SPEC.md and docs/ARCHITECTURE.md for project context
            3. Read CLAUDE.md for coding conventions and constraints
            4. Analyse the request:
               - Is it clear enough to implement? Or are there ambiguities?
               - What priority? (p1=critical, p2=important, p3=nice-to-have)
               - What scope? (small <50 lines, medium 50-200, large 200+)
               - Can the Worker agent implement it, or does it need human judgment?
            5. Post your analysis as a comment on the issue
            6. Update labels:
               - Remove status:needs-triage
               - Add priority:p1/p2/p3
               - Add status:spec-ready (if clear) or status:blocked (if needs clarification)
               - Add agent:worker (if suitable for the worker agent)
               - Add agent:pm
            7. If the issue needs clarification, list your questions in the comment

            Always be specific about which files need to change and what the
            expected behavior should be.

            IMPORTANT — Logging & Diagnostics:
            - Before making API calls, log what you are about to do (e.g. "Posting comment on issue #N", "Adding label X")
            - After each API call, log whether it succeeded or failed, including HTTP status codes
            - If you cannot post a comment or update labels, log the full error response
            - Use the GitHub REST API directly via curl (the gh CLI is NOT available)
            - Authentication: use the GITHUB_TOKEN env var (already set)
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          model: claude-haiku-4-5-20251001
          allowed_tools: "Bash,Read,Glob,Grep"
